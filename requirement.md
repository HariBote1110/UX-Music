# 音楽プレーヤー「UX Music」機能仕様書 (v0.1.6beta)

## 概要
ローカル・オンラインの音源を統合的に管理・再生できるデスクトップ音楽プレーヤー。Electronフレームワークを基盤とし、音源のインポート、再生、管理に関する多岐にわたる機能を提供する。継続的なデバッグと機能改善を経て、安定性とパフォーマンスが向上している。

## 技術スタック
- **フレームワーク:** Electron
- **言語:** JavaScript (Node.js), HTML5, CSS3
- **主要ライブラリ:**
  - `sharp` (アートワークのサムネイル生成・画像処理)
  - `@distube/ytdl-core` (YouTubeのメタデータ取得および動画ダウンロード)
  - `ytpl` (YouTubeプレイリスト情報取得)
  - `music-metadata` (音声ファイルのメタデータ解析)
  - `fluent-ffmpeg`, `ffmpeg-static` (音声ファイルのラウドネス値解析・動画処理)
  - `p-limit` (ラウドネス解析の並列処理制御)
  - `electron-builder` (アプリケーションのビルド・パッケージング)

## 対応OS
- **主要開発・動作確認環境:** macOS, Windows

---

## 主要機能

### 起動パフォーマンス
- **[改善済み] 起動プロセスの最適化**:
  - **モジュールの遅延読み込み**: アプリケーション起動時に不要な機能（YouTube関連、ファイルスキャン関連など）のモジュール読み込みを、実際にその機能が呼び出されるまで遅延させることで、メインプロセスの起動を高速化。
  - **非同期スクリプト実行**: レンダラープロセスのメインスクリプト(`renderer.js`)の読み込みに`defer`属性を使用することで、HTMLの解析をブロックすることなく、UIの表示準備を高速化。

### ライブラリ管理
- **[実装済み] 永続的なライブラリ**: `library.json`と`albums.json`に記録され、アプリを再起動しても維持される。
- **[改善済み] アートワーク管理**:
    - **アルバム単位での管理**: 従来の「1曲1アートワーク」から「1アルバム1アートワーク」のデータ構造に移行。`library.json`を軽量化し、`albums.json`でアートワーク情報を一元管理することで、データ読み込み時のオーバーヘッドを大幅に削減。
    - **サムネイル生成とキャッシュ**: 楽曲インポート時に、リスト表示用の軽量なサムネイル画像（100x100pxのWebP形式）を自動生成してキャッシュ。これにより、リスト表示時の画像読み込み負荷を劇的に軽減。
    - **下位互換性の確保**: 旧バージョン（曲ごと）のアートワークデータを持つ`library.json`を読み込んだ際に、新バージョン（アルバムごと）のデータ構造へ自動的に移行する処理を実装。
- **[実装済み] 多様なインポート方法**:
    - ファイルやフォルダのドラッグ＆ドロップ。
    - YouTubeのURL指定によるインポート。
    - YouTubeプレイリストのURL指定による一括インポート。
- **[改善済み] YouTubeダウンロード機能**:
    - **省データモード**: 「最高品質（映像付きMP4）」か「音声のみ（M4A）」かを選択可能。
    - **映像有無の自動判別**: インポート時にMP4ファイルが映像を持つか音声のみかを自動で判別し、再生時のプレビュー表示を最適化。
    - **ラウドネス値の自動解析**: ダウンロード完了時にラウドネス値を自動で解析し、再生音量を正規化。
- **[実装済み] 楽曲の完全削除**: コンテキストメニューから、ライブラリとファイルシステムの両方から楽曲を完全に削除可能。
- **[実装済み] OS別パフォーマンス最適化**: ラウドネス解析時、Windows環境ではUIの応答性を維持するため、使用するCPUコア数を制限するよう最適化。

### プレイリスト機能
- **[実装済み] プレイリストの作成と永続化**: `m3u8`形式のファイルとして永続的に保存。
- **[実装済み] 楽曲の追加・削除**: ライブラリから曲を追加、プレイリスト詳細画面で曲を削除。
- **[改善済み] YouTubeプレイリストのインポート**:
    - **自動作成**: YouTube上でのプレイリスト名をタイトルとして自動でプレイリストを作成。
    - **エラー耐性**: プレイリスト内に非公開・削除済みの動画が含まれていても、それらをスキップしてインポートを続行可能。
    - **多様なURL形式への対応**: `watch?v=...&list=...` や `/playlist?list=...` など、様々な形式のプレイリストURLに対応。
- **[実装済み] 曲順の並べ替え**: ドラッグ＆ドロップで曲順を変更し、永続的に保存。
- **[実装済み] 名前の変更**: 右クリックメニューからプレイリストの名前を変更可能。

### 再生機能
- **[実装済み] オーディオノーマライザー**:
    - **ハイブリッド解析**: ローカル音源のインポート時または初回再生時にラウドネス値（LUFS）を解析し、再生音量を自動調整。
    - **並列処理**: マルチコアCPUを活用した並列処理によるインポート・解析。
- **[改善済み] 基本再生機能**: 通常再生、全曲リピート、1曲リピート、シャッフル再生。SVGアイコンによるモダンなUIに更新済み。
- **[改善済み] シークバー**:
    - **滑らかな動作**: `requestAnimationFrame`により、再生中のシークバーの動きを滑らかに更新。
    - **ドラッグ中の再生停止**: ユーザーがシークバーをドラッグ中は音声を一時停止し、直感的な操作性を実現。
- **[実装済み] 再生キュー**:
    - **表示と編集**: 現在の再生キューを表示し、ドラッグ＆ドロップで曲順を変更可能。
    - **自動生成**: 「全曲」画面やアルバム、プレイリストから再生した際に、そのリストが再生キューになる。
- **[実装済み] OS連携**: OSのメディアキーから再生/一時停止、曲送り/曲戻しの操作が可能。
- **[実装済み] 再生先コントロール**: 再生デバイスの一覧をポップアップで表示し、出力先を動的に切り替え可能。

### UI・UX
- **[改善済み] アートワークの遅延読み込み (Lazy Loading)**:
    - `IntersectionObserver` APIを利用し、リストやグリッドの表示領域に入ったアートワークのみを読み込むように実装。初期表示の高速化とメモリ使用量を削減。
- **[新規実装] Dynamic Island風イコライザー**:
    - **内容**: 再生中の曲の行番号部分に、リアルタイムの音量に連動して動く6本のバーで構成されたイコライザーを表示。
    - **デザイン**: バーは中央を基準に上下に伸び縮みするカプセル形状（長方形＋半円）を採用。
    - **動的カラー**: ジャケット画像から抽出した2色のグラデーションをバーの色に反映し、視覚的な一体感を向上。
- **[改善済み] UIパーツの視認性向上**:
    - アクセントカラー変更に伴い、再生ボタンのテキスト色を白に変更して視認性を確保。
    - 再生中の曲のハイライトを、テキスト色ではなく背景色を明るくする方式に変更し、歌詞表示とデザインの統一感を向上。
    - 右サイドバーのタブUIのアクティブ表示を改善。
    - アプリケーション全体のダークなトーンに合わせたスクロールバーのデザイン。
- **[実装済み] 歌詞表示**: 再生中の曲名と一致する`.lrc`または`.txt`ファイルを自動で検索し表示。`.lrc`ファイルを優先。
- **[実装済み] 動的プレビュー**: 再生中の曲が映像を持つかどうかに応じて、プレビュー領域のアスペクト比を自動で変更（ビデオ再生時: 16:9、音声のみ再生時: 1:1）。
- **[実装済み] 多様なビュー**: 曲、アルバム、アーティスト、プレイリストの各一覧画面と、それぞれの詳細画面を実装。
- **[改善済み] テキストのスクロールアニメーション**:
    - **内容**: 曲名、アーティスト名、アルバム名など、表示領域からはみ出す長いテキストが、行全体へのマウスオーバー時にスクロール表示される。
    - **実装**: 信頼性の高い`MutationObserver`を用いてDOMの描画完了を検知し、はみ出し判定を行うことで安定動作を実現。
- **[改善済み] アーティスト表示**: `albumartist`タグを優先的に使用し、コンピレーションアルバムなどをより正確にグルーピング。
- **[改善済み] ナビゲーション**:
    - マウスのサイドボタン（戻る）で詳細画面から一覧画面へ戻れるように対応。
    - 曲数が多いアルバムやプレイリストを開いた際に、常に一番上から表示されるように修正。
- **[実装済み] キーボードショートカット**: `0`キーで再生中の曲の先頭にシークする機能を追加。

### デバッグ機能
- **[実装済み] コマンドインターフェイス**: 開発者コンソールから`uxDebug.resetLibrary()`などのコマンドを実行可能。危険な操作には確認ダイアログを表示。
- **[実装済み] ログ転送**: ビルド後のアプリでも、メインプロセスのログを開発者コンソールで確認可能にし、デバッグを容易に。
- **[改善済み] パフォーマンス計測ログ**: メインプロセスとレンダラープロセスの起動シーケンスの各段階でタイムスタンプ付きのログを出力し、ボトルネックの特定を容易にする。

---

## 現在の課題 (Known Issues)

- **[最優先] UIの応答性は高いものの、リソース読み込み完了までに時間がかかる**:
  - **現象**: アプリケーションのUI自体は1秒未満で表示され操作可能になるが、`window.onload`イベントが発火するまでに約15〜25秒かかる。
  - **原因**: 遅延読み込み（Lazy Loading）の実装に問題があり、曲リストの全アートワーク（約500枚以上）が起動直後に一斉に読み込み対象となってしまっている。これにより、バックグラウンドで大量のファイルI/Oが発生し、アプリケーション全体の読み込み完了が著しく遅延している。UIは操作できるものの、DevToolsを開くと右サイドバーの描画が遅れるなどの影響が出ている。
  - **試したこと**: `IntersectionObserver`の`root`をウィンドウ全体からスクロールコンテナに変更したが、解決に至らず。初回読み込み数を制限する方法も効果がなかったため、より根本的なロジックの見直しが必要。

- **[UI/UX] イコライザーの表示**:
  - **現象**: イコライザーのバーが中央ではなく、やや右寄りに表示される。
  - **現象**: WindowsのFHD環境でフルスクリーンにすると、バーの間隔が不均一になる。
  - **現象**: 映像付きの曲（YouTubeなど）を再生すると、イコライザーの色がアートワークから抽出した色に設定されない。

- **[パフォーマンス] Windows環境での音途切れ**:
  - **現象**: Windows環境において、曲がかなりの頻度でごく一瞬途切れる（ジッター）。`i7 12700KF`のような高性能なCPUでも、CPU使用率が15%程度まで上昇することがある。

---

## 今後の課題・将来的な拡張案

### UI/UXの改善
- **設定UIのブラッシュアップ**:
  - **内容**: オーディオデバイスの非表示機能や、ラウドネス解析に使用するCPUコア数の上限を設定できるUIを追加する。
  - **目的**: ユーザーがより細かくアプリケーションの動作を制御できるようにする。
- **再生コントロールのさらなるブラッシュアップ**:
  - **内容**: 再生/一時停止ボタン、進む/戻るボタン、再生バーなどのデザインを、より洗練されたモダンなデザインに更新する。
  - **目的**: ユーザーの操作性を向上させ、視覚的な魅力を高める。
- **テキストのフェードアウト効果**:
  - **内容**: はみ出していない長いテキストの端を、スクロールさせずにフェードアウトさせて表示する。
  - **目的**: テキストが途切れている印象をなくし、より自然で美しい表示を実現する。
- **Dynamic Island風UIの色の調整**:
  - **内容**: ジャケットから抽出する色を、よりダークで落ち着いたトーンに調整する。
  - **目的**: アプリ全体のデザインとの統一感を高める。

### 機能追加
- **プレイリストのピン留め機能**:
  - **内容**: ユーザーが頻繁に聴くお気に入りのプレイリストを、リストの上部や特定のエリアに常に表示（ピン留め）できるようにする。
  - **目的**: 特定のプレイリストへのアクセス性を向上させる。
- **コンテキストに応じた自動プレイリスト生成機能**:
  - **内容**: 曲のメタデータ（ジャンル、リリース年など）や音響的特徴を分析し、現在の「季節（春夏秋冬）」や「時間帯（朝、昼、夜）」といったコンテキストに合わせて、最適なプレイリストを自動で生成する。
  - **目的**: ユーザーの状況に合った音楽体験を自動で作り出す。
- **メタデータ編集機能の実装**:
  - **内容**: アプリ上から曲名、アーティスト名、アルバム名、ジャケット画像などを直接編集し、ファイルに書き込む機能。
  - **方針**: `node-id3`などの外部ライブラリを導入し、右クリックメニューから開ける編集画面を実装する。
- **MP4ファイルのサムネイル自動設定**:
  - **内容**: ユーザーがインポートした映像付きMP4ファイルにアートワークが設定されていない場合、動画のフレームから自動でサムネイルを生成・設定する。
  - **方針**: インポート処理中に`fluent-ffmpeg`を使い、動画の中間地点などからフレームを画像として抽出し、アートワークとして保存する。
- **検索・フィルタリング機能の実装**:
  - **内容**: 曲、アルバム、アーティストなどをキーワードで絞り込める検索バーを実装する。
- **歌詞の自動取得機能**:
  - **内容**: ローカルに歌詞ファイルがない場合、オンラインサービスから歌詞を自動で検索・取得する機能。
  - **方針**: Genius APIなどを利用。ただし、外部サービスの利用規約を遵守する必要がある。
- **複数端末でのライブラリ同期機能**:
  - **内容**: Google Driveなどのクラウドストレージサービスを介して、複数のPCでライブラリ情報や設定を同期する。
  - **方針**: ユーザーが指定した同期フォルダ内に設定ファイル（`library.json`など）を配置。更新時刻を元にデータの競合を解決する。
- **Walkmanへの音楽転送の対応**:
  - **内容**: macOSなど、公式の転送ソフトが対応していないOS向けに、Walkmanへの音楽ファイル転送機能を提供する。