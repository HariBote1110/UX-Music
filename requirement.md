# 音楽プレーヤー「UX Music」機能仕様書 (v2.4)

## 概要
当初の要件定義に基づき開発された、ローカル・オンラインの音源を統合的に管理・再生できるデスクトップ音楽プレーヤー。Electronフレームワークを基盤とし、YouTube音源の扱いに「ダウンロードモード」と「ストリーミングモード」の2つの再生方式を実装。現在はダウンロードモードの機能拡充とライブラリ管理機能の強化に注力している。

## 技術スタック
- **フレームワーク:** Electron
- **言語:** JavaScript (Node.js), HTML5, CSS3
- **主要ライブラリ:**
  - `@distube/ytdl-core` (YouTubeのメタデータ取得および動画ダウンロード)
  - `ytpl` (YouTubeプレイリスト情報取得)
  - `music-metadata` (音声ファイルのメタデータ解析)
  - `fs`, `path` (ファイルシステム操作)

## 対応OS
- **主要開発環境:** macOS
- **ターゲットOS:** macOS, Windows
- **将来的な対応候補:** Linux

## 対応音源
- **ローカルファイル:** MP3, FLAC, WAV, Ogg, M.Aなどの主要な音声ファイル形式、およびMP4動画ファイル
- **オンライン音源:** YouTube（動画およびプレイリスト）

## 主要機能

### ライブラリ管理
- **[実装済み] 永続的なライブラリ**
  - 追加された音源の情報は、ローカル・YouTubeを問わず`library.json`に記録され、アプリを再起動しても維持される。
- **[実装済み] 多様なインポート方法**
  - ファイルやフォルダのドラッグ＆ドロップ。
  - ネットワークフォルダのパス指定によるインポート。
  - YouTubeのURL指定によるインポート。
  - YouTubeプレイリストのURL指定による一括インポート。
- **[実装済み] ダウンロードモードの拡充**
  - **省データモード**: YouTubeからダウンロードする際に、「最高品質（映像付きMP4）」か「音声のみ（M4A）」かを選択できる。設定は永続化される。
  - **ファイルサイズ記録**: YouTubeからダウンロードした楽曲についても、ファイルサイズが正しく記録され、UIに表示される。
  - **品質アップグレード機能**: 「音声のみ」でダウンロードした楽曲と同じURLを「最高品質」で再度追加した場合、古い音声ファイルは自動的に削除され、ライブラリの情報が新しい動画ファイルに置き換えられる。
- **[実装済み] 楽曲の完全削除**
  - 曲リストビューで楽曲を右クリックすると表示されるコンテキストメニューから、ライブラリとファイルシステムの両方から楽曲を完全に削除できる。削除前には確認ダイアログが表示される。

### アーティスト支援機能
- **[実装済み] 公式ハブリンクの表示**
  - YouTubeの楽曲を追加する際、動画の概要欄に`linkco.re`, `fanlink.to`, `fanlink.tv`, `lnk.to`などのハブサービスのURLが含まれている場合、そのURLを楽曲情報に保存する。
  - 該当の楽曲を再生すると、右サイドバーのアーティスト名の下に「公式リンクを開く」ボタンが表示され、クリックするとユーザーの標準ブラウザでそのページを開くことができる。

### プレイリスト機能
- **[実装済み] プレイリストの作成と永続化**
  - `m3u8`形式のファイルとして、アプリの内部データフォルダに永続的に保存される。
- **[実装済み] 楽曲の追加**
  - 曲リストビューで楽曲を右クリックすると表示されるコンテキストメニューから、既存のプレイリストに曲を追加可能。
- **[実装済み] YouTubeプレイリストの自動インポート**
  - YouTubeプレイリストをインポートする際、YouTube上でのプレイリスト名をタイトルとして、UX Music内に自動でプレイリストが作成され、インポートされた曲がすべて追加される。
- **[実装済み] プレイリストからの楽曲削除**
  - プレイリスト詳細画面で楽曲を右クリックすると表示されるコンテキストメニューから、そのプレイリストから曲を削除できる。変更は即座に画面に反映される。
- **[実装済み] プレイリスト詳細表示**
  - プレイリスト一覧画面から特定のプレイリストをクリックすると、そのプレイリストに含まれる楽曲の一覧とヘッダー情報が表示される。

### 再生機能
- **[実装済み] プレーヤーの統合と完全同期**
  - ローカルの音声ファイル、ダウンロードしたビデオのいずれにおいても、単一のプレーヤーUIで再生とプレビューが同期する。
- **[実装済み] オーディオ出力先の選択と自動更新**
  - PCに接続されているオーディオデバイスから出力先を自由に選択・切り替え可能。アプリ起動中にデバイスが増減しても、再起動なしでリストが自動更新される。設定も永続化される。
- **[実装済み] 多様な再生モード**
  - 通常再生、全曲リピート、1曲リピート、シャッフル再生の各モードを搭載。状態はUI上のバッジで視覚的に確認できる。
- **[実装済み] OS連携（メディアコントロール）**
  - macOSのコントロールセンターやキーボードのメディアキーから、再生/一時停止、曲送り/曲戻しの操作が可能。再生中の曲名やアートワークも表示される。

### UI・ビュー
- **[実装済み] 動的アスペクト比のプレビュー**
  - 右サイドバーのプレビュー領域が、再生中のコンテンツに応じてアスペクト比を自動で変更する（ビデオ再生時: 16:9、音声のみ再生時: 1:1）。
- **[実装済み] 動的プレイリストアートワーク（一覧画面）**
  - プレイリスト一覧画面に表示されるアートワークが、プレイリスト内の曲数に応じて動的に生成される（0曲: デフォルトアイコン、1〜3曲: 1枚表示、4曲以上: 4枚のグリッド表示）。
- **[実装済み] アルバム詳細ビュー**
  - アルバム一覧から特定のアルバムをクリックすると、プレイリストと同様の詳細画面に遷移し、収録曲一覧を確認・再生できる。
- **[実装済み] 可変サイドバー**
  - 右サイドバーの幅をユーザーがドラッグして自由に変更できる。

---

## 現在の課題 (Known Issues)

- **[課題] リファクタリング後の安定性検証**
  - **現象**: 大規模なコード分割と整理（リファクタリング）を行ったため、これまでの修正で表面化しなかった軽微な不具合が残存している可能性がある。
  - **対策**: 今後、継続的なテストプレイを通じて、特定の操作や状況下で発生する可能性のあるエッジケース（特殊な不具合）を洗い出し、安定性をさらに向上させる必要がある。

- **[課題] オーディオ出力デバイスの選択がリセットされる**
  - **現象**: 「Music Center for PC」など、ASIOやWASAPI排他モードを使用する可能性のある別の音楽アプリを起動した後にUX Musicを起動すると、以前に選択したオーディオ出力先がリセットされてしまうことがある。
  - **原因推測**: 他のアプリによるオーディオデバイスの排他的な制御が、Electron（Chromium）側のデバイスID認識に影響を与えている可能性が高い。根本的な解決はElectron側の仕様に依存する可能性がある。

## 今後の課題・将来的な拡張案

- **プレイリスト機能の強化**
  - プレイリスト内の曲順をドラッグ＆ドロップで並べ替える機能
  - プレイリスト自体の削除、名前の変更機能
- **アーティストビューの実装**
- **検索・フィルタリング機能の実装**
- **ストリーミングモードの復活と安定化**
- **オンライン動画サイト連携の拡充** (ニコニコ動画など)

- **Walkmanへの音楽転送の対応**
  - **目的**: macOSでは公式の転送ソフトが対応していないため、その代替機能として搭載する。
  - **指定ディレクトリ構造**: "Artist/Album/Musicfile" の形式でファイルを転送し、コンピレーションアルバムは "Various Artists" フォルダにまとめる。
  - **実現可能性評価**:
    - **技術的には十分に実現可能**です。ElectronはPCのファイルシステムにアクセスする能力を持っているため、USBで接続されたWalkmanを外部ストレージとして認識し、指定されたディレクトリ構造でファイルを書き込むことができます。
    - **考慮すべき点**:
      - **接続方式**: Walkmanが一般的なUSBマスストレージとしてではなく、MTP (Media Transfer Protocol) などの特殊な方式で接続される場合、対応するための追加ライブラリが必要となり、開発の難易度が上がります。多くのモデルはUSBマスストレージに対応しているため、大きな障害にはならない可能性が高いです。
      - **UI/UXの設計**: ユーザーが転送先のWalkmanを選択し、転送したい曲（ライブラリ全体、プレイリスト、アルバム単位など）を選び、進捗を確認できるような、直感的で分かりやすいUIを新たに設計・実装する必要があります。
      - **メタデータ**: 転送時に楽曲のメタデータ（MP3タグなど）が正しくファイルに書き込まれているかを確認する、あるいは書き込む機能が必要になる可能性があります。