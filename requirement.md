# 音楽プレーヤー「UX Music」機能仕様書 (v2.5)

## 概要
当初の要件定義に基づき開発された、ローカル・オンラインの音源を統合的に管理・再生できるデスクトップ音楽プレーヤー。Electronフレームワークを基盤とし、YouTube音源の扱いに「ダウンロードモード」と「ストリーミングモード」の2つの再生方式を実装。現在はダウンロードモードの機能拡充とライブラリ管理機能の強化に注力している。

## 技術スタック
- **フレームワーク:** Electron
- **言語:** JavaScript (Node.js), HTML5, CSS3
- **主要ライブラリ:**
  - `@distube/ytdl-core` (YouTubeのメタデータ取得および動画ダウンロード)
  - `ytpl` (YouTubeプレイリスト情報取得)
  - `music-metadata` (音声ファイルのメタデータ解析)
  - `fluent-ffmpeg`, `ffmpeg-static` (音声ファイルのラウドネス値解析)
  - `fs`, `path` (ファイルシステム操作)

## 対応OS
- **主要開発環境:** macOS
- **ターゲットOS:** macOS, Windows
- **将来的な対応候補:** Linux

## 対応音源
- **ローカルファイル:** MP3, FLAC, WAV, Ogg, M4Aなどの主要な音声ファイル形式、およびMP4動画ファイル
- **オンライン音源:** YouTube（動画およびプレイリスト）
- **歌詞ファイル:** LRC (同期歌詞), TXT (通常歌詞)

## 主要機能

### ライブラリ管理
- **[実装済み] 永続的なライブラリ**
  - 追加された音源の情報は、ローカル・YouTubeを問わず`library.json`に記録され、アプリを再起動しても維持される。
- **[実装済み] 多様なインポート方法**
  - ファイルやフォルダのドラッグ＆ドロップ。
  - ネットワークフォルダのパス指定によるインポート。
  - YouTubeのURL指定によるインポート。
  - YouTubeプレイリストのURL指定による一括インポート。
- **[実装済み] ダウンロードモードの拡充**
  - **省データモード**: YouTubeからダウンロードする際に、「最高品質（映像付きMP4）」か「音声のみ（M4A）」かを選択できる。設定は永続化される。
  - **ファイルサイズ記録**: YouTubeからダウンロードした楽曲についても、ファイルサイズが正しく記録され、UIに表示される。
  - **品質アップグレード機能**: 「音声のみ」でダウンロードした楽曲と同じURLを「最高品質」で再度追加した場合、古い音声ファイルは自動的に削除され、ライブラリの情報が新しい動画ファイルに置き換えられる。
- **[実装済み] 楽曲の完全削除**
  - 曲リストビューで楽曲を右クリックすると表示されるコンテキストメニューから、ライブラリとファイルシステムの両方から楽曲を完全に削除できる。削除前には確認ダイアログが表示される。

### アーティスト支援機能
- **[実装済み] 公式ハブリンクの表示**
  - YouTubeの楽曲を追加する際、動画の概要欄に`linkco.re`, `fanlink.to`などのハブサービスのURLが含まれている場合、そのURLを楽曲情報に保存する。
  - 該当の楽曲を再生すると、右サイドバーのアーティスト名の下に「公式リンクを開く」ボタンが表示される。

### プレイリスト機能
- **[実装済み] プレイリストの作成と永続化**
  - `m3u8`形式のファイルとして、アプリの内部データフォルダに永続的に保存される。
- **[実装済み] 楽曲の追加・削除**
  - 曲リストから既存のプレイリストに曲を追加可能。
  - プレイリスト詳細画面で曲を削除可能。
- **[実装済み] YouTubeプレイリストの自動インポート**
  - YouTubeプレイリストをインポートする際、YouTube上でのプレイリスト名をタイトルとして自動でプレイリストが作成され、インポートされた曲がすべて追加される。
- **[実装済み] プレイリスト管理機能**
  - **削除:** プレイリスト一覧画面で、プレイリストを右クリックして削除できる。
  - **曲順の並べ替え:** プレイリスト詳細画面で、楽曲をドラッグ＆ドロップして曲順を自由に変更できる。変更は永続的に保存される。

### 再生機能
- **[実装済み] プレーヤーの統合とUIの分離**
  - 再生状態と画面表示が完全に分離されており、音楽を再生しながらライブラリ内を自由に探索できる。
- **[実装済み] オーディオノーマライザー**
  - 各楽曲のラウドネス値（LUFS）を解析し、目標値に近づくように再生音量を自動で調整する。
  - **ハイブリッド解析:** 楽曲のインポート時にラウドネス値を自動解析。未解析の楽曲が再生された場合は、再生時にバックグラウンドで解析を実行する。
- **[実装済み] オーディオ出力先の選択と自動更新**
  - PCに接続されているオーディオデバイスから出力先を自由に選択・切り替え可能。
- **[実装済み] 多様な再生モード**
  - 通常再生、全曲リピート、1曲リピート、シャッフル再生。
- **[実装済み] OS連携（メディアコントロール）**
  - OSのメディアキーから再生/一時停止、曲送り/曲戻しの操作が可能。

### UI・ビュー
- **[実装済み] 歌詞表示機能**
  - **ファイル関連付け:** 再生中の曲のファイル名またはメタデータの曲名と同じ名前の歌詞ファイル（.lrc, .txt）を自動で検索し表示。
  - **同期表示:** LRCファイルの場合、再生時間に合わせて歌詞がハイライトされ、自動でスクロールする。
  - **インポート:** 歌詞ファイルをアプリにドラッグ＆ドロップして簡単に追加できる。
- **[実装済み] 動的アスペクト比のプレビュー**
  - 右サイドバーのプレビュー領域が、コンテンツに応じてアスペクト比を自動で変更する（ビデオ再生時: 16:9、音声のみ再生時: 1:1）。
- **[実装済み] アーティストビュー**
  - ライブラリ内のアーティストを一覧表示し、クリックするとそのアーティストのアルバム一覧画面に遷移する。
- **[実装済み] アルバム詳細ビュー**
  - アルバム一覧から特定のアルバムをクリックすると、収録曲一覧を確認・再生できる。
- **[実装済み] 非占有型の通知**
  - ファイルのインポート時やラウドネス解析の待機中に、画面全体を覆うのではなく、右下にトースト通知を表示する。

---

## 現在の課題 (Known Issues)

- **[課題] 大規模リファクタリング後の安定性検証**
  - **現象**: UI関連のロジックを中心に大規模なコード分割（リファクタリング）を行ったため、これまでの修正で表面化しなかった軽微な不具合が残存している可能性がある。
  - **対策**: 今後、継続的なテストプレイを通じて、特定の操作や状況下で発生する可能性のあるエッジケースを洗い出し、安定性をさらに向上させる必要がある。

- **[課題] オーディオ出力デバイスの選択がリセットされる**
  - **現象**: 他の音楽アプリを起動した後にUX Musicを起動すると、以前に選択したオーディオ出力先がリセットされてしまうことがある。
  - **原因推測**: 他のアプリによるオーディオデバイスの排他的な制御が、Electron（Chromium）側のデバイスID認識に影響を与えている可能性が高い。

---

## 今後の課題・将来的な拡張案

- **プレイリスト機能の強化**
  - プレイリスト自体の名前を変更する機能
- **検索・フィルタリング機能の実装**
- **複数端末でのライブラリ同期機能**
  - **案:** ユーザーが指定したGoogle Driveなどのファイル同期サービス内のフォルダを「同期フォルダ」とし、その中に音楽ファイルや設定ファイル (`library.json`, `playcounts.json`など) を配置する。再生回数などの競合は、データの更新時刻（タイムスタンプ）を比較して解決する。
- **歌詞の自動取得機能**
  - **案:** ユーザーが自身のGenius APIキーなどを設定画面で入力することで、歌詞がローカルにない場合に自動でオンライン検索・取得する機能。
  - **課題:** Geniusなどの外部サービスの利用規約が、第三者アプリでの利用を厳しく制限している可能性があり、実装前に許諾の確認が必要。
- **Walkmanへの音楽転送の対応**
  - **目的:** macOSでは公式の転送ソフトが対応していないため、その代替機能として搭載する。