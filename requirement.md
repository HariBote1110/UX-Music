# 音楽プレーヤー「UX Music」機能仕様書 (v2.3)

## 概要
当初の要件定義に基づき開発された、ローカル・オンラインの音源を統合的に管理・再生できるデスクトップ音楽プレーヤー。Electronフレームワークを基盤とし、YouTube音源の扱いに「ダウンロードモード」と「ストリーミングモード」の2つの再生方式を実装。現在はダウンロードモードの機能拡充とライブラリ管理機能の強化に注力している。

## 技術スタック
- **フレームワーク:** Electron
- **言語:** JavaScript (Node.js), HTML5, CSS3
- **主要ライブラリ:**
  - `@distube/ytdl-core` (YouTubeのメタデータ取得および動画ダウンロード)
  - `ytpl` (YouTubeプレイリスト情報取得)
  - `music-metadata` (音声ファイルのメタデータ解析)
  - `fs`, `path` (ファイルシステム操作)

## 対応OS
- **主要開発環境:** macOS
- **ターゲットOS:** macOS, Windows
- **将来的な対応候補:** Linux

## 対応音源
- **ローカルファイル:** MP3, FLAC, WAV, Ogg, M4Aなどの主要な音声ファイル形式、およびMP4動画ファイル
- **オンライン音源:** YouTube（動画およびプレイリスト）

## 主要機能

### ライブラリ管理
- **[実装済み] 永続的なライブラリ**
  - 追加された音源の情報は、ローカル・YouTubeを問わず`library.json`に記録され、アプリを再起動しても維持される。

- **[実装済み] 多様なインポート方法**
  - ファイルやフォルダのドラッグ＆ドロップ。
  - ネットワークフォルダのパス指定によるインポート。
  - YouTubeのURL指定によるインポート。
  - YouTubeプレイリストのURL指定による一括インポート。

- **[実装済み] ダウンロードモードの拡充**
  - **省データモード**: YouTubeからダウンロードする際に、「最高品質（映像付きMP4）」か「音声のみ（M4A）」かを選択できる。設定は永続化される。
  - **ファイルサイズ記録**: YouTubeからダウンロードした楽曲についても、ファイルサイズが正しく記録され、UIに表示される。
  - **品質アップグレード機能**: 「音声のみ」でダウンロードした楽曲と同じURLを「最高品質」で再度追加した場合、古い音声ファイルは自動的に削除され、ライブラリの情報が新しい動画ファイルに置き換えられる。

- **[一部実装済み] 楽曲の完全削除**
  - 曲リストビューで楽曲を右クリックすると表示されるコンテキストメニューから、ライブラリとファイルシステムの両方から楽曲を完全に削除できる。削除前には確認ダイアログが表示される。

### アーティスト支援機能
- **[実装済み] 公式ハブリンクの表示**
  - YouTubeの楽曲を追加する際、動画の概要欄に`linkco.re`, `fanlink.to`, `fanlink.tv`, `lnk.to`などのハブサービスのURLが含まれている場合、そのURLを楽曲情報に保存する。
  - 該当の楽曲を再生すると、右サイドバーのアーティスト名の下に「公式リンクを開く」ボタンが表示され、クリックするとユーザーの標準ブラウザでそのページを開くことができる。

### プレイリスト機能
- **[実装済み] プレイリストの作成と永続化**
  - `m3u8`形式のファイルとして、アプリの内部データフォルダに永続的に保存される。

- **[実装済み] 楽曲の追加**
  - 曲リストビューで楽曲を右クリックすると表示されるコンテキストメニューから、既存のプレイリストに曲を追加可能。

- **[実装済み] YouTubeプレイリストの自動インポート**
  - YouTubeプレイリストをインポートする際、YouTube上でのプレイリスト名をタイトルとして、UX Music内に自動でプレイリストが作成され、インポートされた曲がすべて追加される。

- **[実装済み] プレイリストからの楽曲削除**
  - プレイリスト詳細画面で楽曲を右クリックすると表示されるコンテキストメニューから、そのプレイリストから曲を削除できる。変更は即座に画面に反映される。

- **[実装済み] プレイリスト詳細表示**
  - プレイリスト一覧画面から特定のプレイリストをクリックすると、そのプレイリストに含まれる楽曲の一覧とヘッダー情報が表示される。

### 再生機能
- **[実装済み] プレーヤーの統合と完全同期**
  - ローカルの音声ファイル、ダウンロードしたビデオのいずれにおいても、単一のプレーヤーUIで再生とプレビューが同期する。

- **[実装済み] オーディオ出力先の選択**
  - ダウンロードモードでローカルファイルを再生する場合に限り、PCに接続されているオーディオデバイスから出力先を自由に選択・切り替え可能。設定も永続化される。

### UI・ビュー
- **[実装済み] 動的アスペクト比のプレビュー**
  - 右サイドバーのプレビュー領域が、再生中のコンテンツに応じてアスペかクト比を自動で変更する（ビデオ再生時: 16:9、音声のみ再生時: 1:1）。

- **[実装済み] 動的プレイリストアートワーク（一覧画面）**
  - プレイリスト一覧画面に表示されるアートワークが、プレイリスト内の曲数に応じて動的に生成される（0曲: デフォルトアイコン、1〜3曲: 1枚表示、4曲以上: 4枚のグリッド表示）。
  
- **[実装済み] 可変サイドバー**
  - 右サイドバーの幅をユーザーがドラッグして自由に変更できる。

---

## 現在の課題 (Known Issues)

- **[最優先課題] 楽曲削除後のUI更新バグ**
  - **現象**: 曲リストビューから楽曲を削除しても、UI（曲リスト）が自動で更新されず、削除したはずの曲が表示されたままになる。再生はできなくなるが、見た目上は残っているように見える。
  - **原因**: メインプロセスからレンダラープロセスへのUI更新通知（`force-reload-library`）が正しく画面の再描画に繋がっていない。プロセス間のデータの流れと、UI更新のトリガーを見直す必要がある。

- **[課題] プレイリスト詳細画面のアートワーク表示バグ**
  - **現象**: プレイリスト詳細画面のヘッダーで、楽曲のアートワークを表示する際に、3曲以下の場合はアートワークが1枚だけ大きく表示されるべきだが、コンテナ全体に広がらず左上のセル内に収まってしまう。
  - **状況**: CSSとJavaScriptによる表示切り替えを試みたが、未解決。根本的なレイアウト計算の見直しが必要。

- **[課題] オーディオ出力デバイスの選択がリセットされる**
  - **現象**: 「Music Center for PC」など、ASIOやWASAPI排他モードを使用する可能性のある別の音楽アプリを起動した後にUX Musicを起動すると、以前に選択したオーディオ出力先（例: スピーカー）がリセットされ、意図しないデバイスが選択されてしまうことがある。
  - **原因推測**: 他のアプリによるオーディオデバイスの排他的な制御が、Electron（Chromium）側のデバイスID認識に影響を与えている可能性が高い。

## 今後の課題・将来的な拡張案
- **プレイリスト機能の強化**
  - プレイリスト内の曲順をドラッグ＆ドロップで並べ替える機能
  - プレイリスト自体の削除、名前の変更機能
- **アーティストビューの実装**
- **検索・フィルタリング機能の実装**
- **ストリーミングモードの復活と安定化**
- **オンライン動画サイト連携の拡充** (ニコニコ動画など)

- **Walkmanへの音楽転送の対応**
    - macOSではMusic Center for PCが対応していないので代替機能として搭載したい。
    - ディレクトリ階層は"Artist/Album/Musicfile"のような形で、コンピュレーションアルバムはVarious artistsにする。