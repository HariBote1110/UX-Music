# 音楽プレーヤー「UX Music」機能仕様書 (v0.1.3暫定)

## 概要
ローカル・オンラインの音源を統合的に管理・再生できるデスクトップ音楽プレーヤー。Electronフレームワークを基盤とし、音源のインポート、再生、管理に関する多岐にわたる機能を提供する。継続的なデバッグと機能改善を経て、安定性とパフォーマンスが向上している。

## 技術スタック
- **フレームワーク:** Electron
- **言語:** JavaScript (Node.js), HTML5, CSS3
- **主要ライブラリ:**
  - `@distube/ytdl-core` (YouTubeのメタデータ取得および動画ダウンロード)
  - `ytpl` (YouTubeプレイリスト情報取得)
  - `music-metadata` (音声ファイルのメタデータ解析)
  - `fluent-ffmpeg`, `ffmpeg-static` (音声ファイルのラウドネス値解析・動画処理)
  - `p-limit` (ラウドネス解析の並列処理制御)
  - `electron-builder` (アプリケーションのビルド・パッケージング)

## 対応OS
- **主要開発・動作確認環境:** macOS, Windows

## 主要機能

### ライブラリ管理
- **[実装済み] 永続的なライブラリ**: `library.json`に記録され、アプリを再起動しても維持される。
- **[実装済み] 多様なインポート方法**:
    - ファイルやフォルダのドラッグ＆ドロップ。
    - YouTubeのURL指定によるインポート。
    - YouTubeプレイリストのURL指定による一括インポート。
- **[改善済み] YouTubeダウンロード機能**:
    - **省データモード**: 「最高品質（映像付きMP4）」か「音声のみ（M4A）」かを選択可能。
    - **映像有無の自動判別**: インポート時にMP4ファイルが映像を持つか音声のみかを自動で判別し、再生時のプレビュー表示を最適化。
- **[改善済み] アートワーク管理**:
    - `library.json`からBase64データを分離。アートワークを専用フォルダに画像ファイルとして保存し、ライブラリの軽量化と高速化を実現。
- **[実装済み] 楽曲の完全削除**: コンテキストメニューから、ライブラリとファイルシステムの両方から楽曲を完全に削除可能。

### プレイリスト機能
- **[実装済み] プレイリストの作成と永続化**: `m3u8`形式のファイルとして永続的に保存。
- **[実装済み] 楽曲の追加・削除**: ライブラリから曲を追加、プレイリスト詳細画面で曲を削除。
- **[改善済み] YouTubeプレイリストのインポート**:
    - **自動作成**: YouTube上でのプレイリスト名をタイトルとして自動でプレイリストを作成。
    - **エラー耐性**: プレイリスト内に非公開・削除済みの動画が含まれていても、それらをスキップしてインポートを続行可能。
    - **多様なURL形式への対応**: `watch?v=...&list=...` や `/playlist?list=...` など、様々な形式のプレイリストURLに対応。
- **[実装済み] 曲順の並べ替え**: ドラッグ＆ドロップで曲順を変更し、永続的に保存。
- **[実装済み] 名前の変更**: 右クリックメニューからプレイリストの名前を変更可能。

### 再生機能
- **[実装済み] オーディオノーマライザー**:
    - **ハイブリッド解析**: インポート時または初回再生時にラウドネス値（LUFS）を解析し、再生音量を自動調整。
    - **並列処理**: マルチコアCPUを活用した並列処理によるインポート・解析（macOSでは動作確認済み）。
- **[実装済み] 基本再生機能**: 通常再生、全曲リピート、1曲リピート、シャッフル再生。
- **[実装済み] 再生キュー**:
    - **表示と編集**: 現在の再生キューを表示し、ドラッグ＆ドロップで曲順を変更可能。
    - **自動生成**: 「全曲」画面やアルバム、プレイリストから再生した際に、そのリストが再生キューになる。
- **[実装済み] OS連携**: OSのメディアキーから再生/一時停止、曲送り/曲戻しの操作が可能。

### UI・UX
- **[改善済み] CSSのコンポーネント化**: `style.css`を機能ごとに`base.css`, `layout.css`, `components.css`, `views.css`に分割し、メンテナンス性を向上。
- **[改善済み] アクセントカラーの調整**: アプリケーションのアクセントカラー（ピンクとブルー）を、より深みのある落ち着いた色合いに変更。
- **[改善済み] UIパーツの視認性向上**:
    - アクセントカラー変更に伴い、再生ボタンのテキスト色を白に変更して視認性を確保。
    - 再生中の曲のハイライトを、テキスト色ではなく背景色を明るくする方式に変更し、歌詞表示とデザインの統一感を向上。
- **[実装済み] 歌詞表示**: 再生中の曲名と一致する`.lrc`または`.txt`ファイルを自動で検索し表示。`.lrc`ファイルを優先。
- **[実装済み] 動的プレビュー**: 再生中の曲が映像を持つかどうかに応じて、プレビュー領域のアスペクト比を自動で変更（ビデオ再生時: 16:9、音声のみ再生時: 1:1）。
- **[実装済み] 多様なビュー**: 曲、アルバム、アーティスト、プレイリストの各一覧画面と、それぞれの詳細画面を実装。
- **[改善済み] アーティスト表示**: `albumartist`タグを優先的に使用し、コンピレーションアルバムなどをより正確にグルーピング。
- **[改善済み] ナビゲーション**:
    - マウスのサイドボタン（戻る）で詳細画面から一覧画面へ戻れるように対応。
    - 曲数が多いアルバムやプレイリストを開いた際に、常に一番上から表示されるように修正。
- **[実装済み] キーボードショートカット**: `0`キーで再生中の曲の先頭にシークする機能を追加。

### デバッグ機能
- **[実装済み] コマンドインターフェイス**: 開発者コンソールから`uxDebug.resetLibrary()`などのコマンドを実行可能。危険な操作には確認ダイアログを表示。
- **[実装済み] ログ転送**: ビルド後のアプリでも、メインプロセスのログを開発者コンソールで確認可能にし、デバッグを容易に。

---
## 現在の課題 (Known Issues)

- **[最優先課題] Windows環境でのラウドネス解析の不具合**:
  - **現象**: Windows環境において、ファイルやフォルダをドラッグ＆ドロップでインポートした際に、ラウドネス解析処理が実行されない。インポートが一瞬で完了し、楽曲の初回再生時に初めて解析が走る状態になっている。
  - **原因推測**: `fluent-ffmpeg`の呼び出しや、`p-limit`による並列処理、あるいは`crypto`モジュールなど、Node.jsのコア機能と外部プロセスが連携する部分で、Windows特有のパスの扱いやプロセス管理との相性問題が発生している可能性が高い。複数回の修正を試みたが、根本的な解決には至っていない。

---
## 今後の課題・将来的な拡張案

- **メタデータ編集機能の実装**:
  - **内容**: アプリ上から曲名、アーティスト名、アルバム名、ジャケット画像などを直接編集し、ファイルに書き込む機能。
  - **方針**: `node-id3`などの外部ライブラリを導入し、右クリックメニューから開ける編集画面を実装する。

- **MP4ファイルのサムネイル自動設定**:
  - **内容**: ユーザーがインポートした映像付きMP4ファイルにアートワークが設定されていない場合、動画のフレームから自動でサムネイルを生成・設定する。
  - **方針**: インポート処理中に`fluent-ffmpeg`を使い、動画の中間地点などからフレームを画像として抽出し、アートワークとして保存する。

- **検索・フィルタリング機能の実装**:
  - **内容**: 曲、アルバム、アーティストなどをキーワードで絞り込める検索バーを実装する。

- **歌詞の自動取得機能**:
  - **内容**: ローカルに歌詞ファイルがない場合、オンラインサービスから歌詞を自動で検索・取得する機能。
  - **方針**: Genius APIなどを利用。ただし、外部サービスの利用規約を遵守する必要がある。

- **複数端末でのライブラリ同期機能**:
  - **内容**: Google Driveなどのクラウドストレージサービスを介して、複数のPCでライブラリ情報や設定を同期する。
  - **方針**: ユーザーが指定した同期フォルダ内に設定ファイル（`library.json`など）を配置。更新時刻を元にデータの競合を解決する。

- **Walkmanへの音楽転送の対応**:
  - **内容**: macOSなど、公式の転送ソフトが対応していないOS向けに、Walkmanへの音楽ファイル転送機能を提供する。