# 音楽プレーヤー「UX Music」機能仕様書 (v0.1.9 Alpha 1e)

## 概要
ローカル・オンラインの音源を統合的に管理・再生できるデスクトップ音楽プレーヤー。Electronフレームワークを基盤とし、音源のインポート、再生、管理に関する多岐にわたる機能を提供する。継続的なデバッグと機能改善を経て、安定性とパフォーマンスが向上している。

## 技術スタック
- **フレームワーク:** Electron
- **言語:** JavaScript (Node.js), HTML5, CSS3
- **主要ライブラリ:**
  - `sharp` (アートワークのサムネイル生成・画像処理)
  - `@distube/ytdl-core` (YouTubeのメタデータ取得および動画ダウンロード)
  - `ytpl` (YouTubeプレイリスト情報取得)
  - `music-metadata` (音声ファイルのメタデータ解析)
  - `fluent-ffmpeg`, `ffmpeg-static` (音声ファイルのラウドネス値・BPM・雰囲気解析)
  - `music-tempo`, `wav-decoder`, `tmp` (BPM解析)
  - `electron-builder` (アプリケーションのビルド・パッケージング)

## 対応OS
- **主要開発・動作確認環境:** macOS, Windows

> [!WARNING]
> **ハイパワーマシン向け**
> このアプリケーションは、楽曲のインポート時に音声解析などの処理を行うため、CPUリソースを消費する場合があります。設定から「パフォーマンスモード」を選択することで、PCのリソースを最大限活用し、インポートを高速化できます。

---

## 主要機能

### 起動とパフォーマンス
- **[改善済み] 起動プロセスの最適化**:
  - **モジュールの遅延読み込み**: YouTube関連など、アプリ起動時に不要な機能のモジュール読み込みを遅延させ、メインプロセスの起動を高速化。
- **[改善済み] インポート処理の高速化と安定化**:
    - **バックグラウンド処理**: ラウドネス、BPM、Energyの解析処理を**Web Worker**に完全分離。これにより、重いインポート中でもUIが「応答なし」になる問題を根本的に解決。
    - **パフォーマンスモード**: PCの搭載メモリ量に応じて並列処理数を動的に増減させるインテリジェントなモードを実装。これにより、ハイスペックPCではその性能を最大限に活かした超高速インポートが可能に。
    - **軽量な音量解析**: 従来の`loudnorm`から高速な`volumedetect`および`astats`フィルターに切り替えたことで、CPU負荷と発熱を大幅に削減し、インポート時間を劇的に短縮（例: 10分→30秒）。
- **[改善済み] 待機中のリソース消費削減**:
    - **アイドル状態の検知**: 5分間ユーザーの操作がない場合に、CSSアニメーションなどを停止する「スリープモード」を実装。これにより、アプリを長時間起動したままでもCPUリソースをほとんど消費しない。
    - **ビジュアライザーのエコモード**: 再生中の曲が画面外にスクロールされると、ビジュアライザーの描画を完全に停止し、CPU負荷を大幅に軽減。

### ライブラリ管理
- **[改善済み] 楽曲分析機能**:
    - **雰囲気分析(Energy)**: FFmpegの`astats`フィルターを利用し、曲のダイナミックレンジ（音量の起伏）を`Energy`として数値化。これにより、「For You」プレイリストの精度が向上。
    - **BPM解析**:
        - **[修正済み]** インポート時にBPMが欠落する問題を修正。
        - **[修正済み]** `fluent-ffmpeg`がハングアップする問題を、一時ファイルを利用する安定した方式に変更して解決。
        - **[改善済み]** BPMが2倍で検出される「倍テン」問題を、180BPMを超える場合に半減させるロジックを追加して補正。
    - **ジャンル取得**: インポート時に楽曲のメタデータからジャンル情報を取得し、ライブラリに保存。

### For You 機能 (自動プレイリスト生成)
- **[新規] パーソナルプレイリスト**:
    - **再生日時の記録**: 曲の再生履歴（いつ聴いたか）を記録する仕組みを追加。
    - **再生傾向の分析**: 記録されたデータを基に、以下のプレイリストを自動生成。
        - **最近のお気に入り**: 直近2週間でよく聴いた曲。
        - **ちょっと前のお気に入り**: 2週間〜3ヶ月前によく聴いていた、最近はあまり聴いていない曲。
        - **変わらない愛曲**: 総再生回数が多く、長期的に愛聴されている曲。
- **[改善済み] シチュエーションプレイリスト**:
    - **動的生成**: 現在の**時刻**（朝、昼、夕方、深夜）や**季節**（夏、冬）に応じて、表示されるプレイリストが自動で変化。
    - **高度なルール設定**: BPM、ジャンル、Energy、タイトルキーワードを組み合わせ、さらに特定のキーワードを除外（減点）するルールを導入し、プレイリストの精度を大幅に向上。（例: 「爽やかな朝に」プレイリストから「夜」という単語が入った曲を除外）

### UI・UX
- **[改善済み] レスポンシブデザイン**: ウィンドウ幅が一定（940px）より狭くなると、右サイドバーが自動的に折りたたまれ、曲リストの表示崩れを防ぐように修正。

---

## 現在の課題 (Known Issues)

-   **[新規] インポート時の曲順が乱れる**:
    -   **現象**: 複数のフォルダやファイルを一度にインポートすると、バックグラウンドでの並列処理の完了順によって、ライブラリに追加される曲の順番が元のファイル順と異なる場合がある。
-   **[新規] 右サイドバーの幅が調整できない**:
    -   **現象**: 左右のサイドバーを区切るリサイザーをドラッグしても、右サイドバー（プレビュー領域）の幅を変更できない。

---

## 今後の課題・将来的な拡張案

### UI/UXの改善
- **[新規-Alpha 2で実装予定] ビジュアライザーのモード切替**:
  - **内容**: CPU負荷をさらに軽減したいユーザー向けに、設定画面からビジュアライザーの種類を選択できるようにする。
    - **アクティブビジュアライザー (現在)**: 曲の音声データをリアルタイムで解析して描画するモード。
    - **スタティックビジュアライザー (軽量版)**: 音声解析を行わず、あらかじめ決められた動きを繰り返す、よりCPU負荷の低いモード。
  - **目的**: 低スペックPCでのさらなる快適性の向上。
- **設定UIのブラッシュアップ**:
  - **内容**: オーディオデバイスの非表示機能や、ラウドネス解析に使用するCPUコア数の上限を設定できるUIを追加する。
  - **目的**: ユーザーがより細かくアプリケーションの動作を制御できるようにする。
- **再生コントロールのさらなるブラッシュアップ**:
  - **内容**: 再生/一時停止ボタン、進む/戻るボタン、再生バーなどのデザインを、より洗練されたモダンなデザインに更新する。
  - **目的**: ユーザーの操作性を向上させ、視覚的な魅力を高める。
- **テキストのフェードアウト効果**:
  - **内容**: はみ出していない長いテキストの端を、スクロールさせずにフェードアウトさせて表示する。
  - **目的**: テキストが途切れている印象をなくし、より自然で美しい表示を実現する。

### 機能追加
- **メタデータ編集機能の実装**:
  - **内容**: アプリ上から曲名、アーティスト名、アルバム名、ジャケット画像などを直接編集し、ファイルに書き込む機能。
- **MP4ファイルのサムネイル自動設定**:
  - **内容**: ユーザーがインポートした映像付きMP4ファイルにアートワークが設定されていない場合、動画のフレームから自動でサムネイルを生成・設定する。
- **検索・フィルタリング機能の実装**:
  - **内容**: 曲、アルバム、アーティストなどをキーワードで絞り込める検索バーを実装する。
- **歌詞の自動取得機能**:
  - **内容**: ローカルに歌詞ファイルがない場合、オンラインサービスから歌詞を自動で検索・取得する機能。